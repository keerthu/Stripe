<?xml version="1.0" encoding="UTF-8"?>
<template name="init" xmlns="http://ws.apache.org/ns/synapse">
    <parameter name="apiUrl" description="URL of the Spotify API" />
    <parameter name="apiVersion" description="Api Version" />
    <parameter name="apiKey" description="API key" />
    <sequence>
        <property name="uri.var.apiUrl" expression="$func:apiUrl" />
        <property name="uri.var.apiVersion" expression="$func:apiVersion" />
        <property name="uri.var.apiKey" expression="$func:apiKey" />
        <filter source="boolean(get-property('uri.var.apiUrl'))" regex="false">
            <then>
                <property name="uri.var.apiUrl" value="https://api.stripe.com" />
            </then>
        </filter>
        <filter source="boolean(get-property('uri.var.apiVersion'))" regex="false">
            <then>
                <property name="uri.var.apiVersion" value="v1" />
            </then>
        </filter>
        <filter source="boolean(get-property('uri.var.apiKey'))" regex="true">
            <then>
                <header name="Authorization"  expression="fn:concat('Bearer ',get-property('uri.var.apiKey'))" scope="transport"/>
            </then>
        </filter>

        <header name="Content-Type" value="application/x-www-form-urlencoded" scope="transport" />
    </sequence>

</template>